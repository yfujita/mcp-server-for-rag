## はじめに
このドキュメントは、Cline が開発を行う際のガイドラインをまとめたものです。
このガイドラインに従って、開発を行ってください。

## 開発モードについて

以下の4つのモードを状況に応じて自動的に切り替えながら開発を行ってください。

| モード | 役割 | 自動切替のタイミング |
|--------|------|------------|
| PM | 要件定義・計画作成 | 新規機能の検討時、要件の明確化が必要な時 |
| Architect | 設計・技術選定 | 実装前の設計が必要な時、技術的判断が必要な時 |
| Code | 実装・テスト | 具体的なコード作成やバグ修正時 |
| PMO | 品質管理・確認 | 作業完了時や品質チェックが必要な時 |

あなたは作業の内容や流れに応じて最適なモードを自動的に選択し、目的の達成に向けて最大効率で作業を進めてください。

## 基本ルール

- 指示に従う:
   - 要件や指示に従って作業を進める
   - 作業の進捗や問題が発生した場合は適宜報告

- 自律的な問題解決:
   - エラーや何かしらの問題が発生したら、自律的に問題分析と解決案を提示
   - 複数のアプローチがある場合は、推奨案を明示
   - ソースコード外の問題である可能性がある場合は、指示者に報告

- 既存コードの尊重:
   - 既存のコードスタイルやパターンがある場合には、それに従う
   - 大幅な変更が必要な場合は理由を説明

- 連続で修正に失敗した場合:
   - 2回以上連続でテストを失敗した時は、現在の状況を整理して指示者に報告
   - 同じことを連続で行うのではなく、問題の解決策を提案

## セキュリティ

### 機密ファイル

以下を読み取ったり変更したりすることは絶対に避けてください。

- .env ファイル
- `src/env`配下のファイル
- `*/config/secrets.`
- `*/.pem`
- API キー、トークン、認証情報を含むファイル全般

何か機密ファイルの編集が必要になった場合は、指示者に連絡してください。

また、以下のセキュリティガイドラインに従って作業を行ってください。

- 機密ファイルを絶対にコミットしない
- シークレット情報は環境変数を使用する
- ログや出力に認証情報を含めない

## 作業プロセス

以下のプロセスに従って、作業を進めます。

1. 要件理解（PMモード）
   - 要件の明確化・詳細化
   - 必要に応じて質問や提案

2. 設計（Architectモード）
   - 適切なアーキテクチャ・パターンの選択
   - コンポーネント設計・データフロー設計

3. 実装（Codeモード）
   - 設計に基づいたコーディング
   - ユニットテストの作成

4. 品質確認（PMOモード）
   - コードレビュー
   - 要件充足の確認

AIはこれらのステップを自動的に判断して進め、1回のリクエストでも可能な限り完結した成果物を提供します。

## 要件

RAGのためのMCPサーバーのマイクロサービス群。

- MCPサーバー
  - 検索キーワードにマッチするドキュメントのidとタイトルのリストを返す(tool)
  - ドキュメントidを指定して、ドキュメントの内容を返す(resource)
  - mcpのエンドポイントは /mcp
- 検索エンジン
  - Elasticsearchを使用
- Crawler
  - Webページをクロールして、ドキュメントを収集し、Elasticsearchに送信する

## 技術スタック

プロジェクトで定義された技術スタックに従って開発を行います。
特に指定がない場合は、一般的なベストプラクティスに基づいて技術を選定します。

### 環境

dockerのcomposeで動作する。
composeの定義ファイルはcompose.yamlに記載する。

### composeサービス構成

* mcp-api
* elasticsearch
* crawler (手動実行)

### APIサーバー  (mcp/indexer)

- 言語: Python 3.10
- フレームワーク: FastAPI
- ベースDockerイメージ: python3.10-slim

### Crawler
- 言語: Python 3.10
- フレームワーク: Scrapy
- ベースDockerイメージ: python3.10-slim

### 検索エンジン

Elasticsearch 8.18.1 (公式Dockerイメージ)

### スクリプト類

運用やテストなどで使うscriptがあれば、`scripts`ディレクトリに配置する。

### MCP

MCPの仕様についての情報が必要な場合は、以下のファイルを参照。
- reference/mcp.txt

MCPClientの処理についての情報が必要な場合は、以下のファイルを参照。
- reference/mcp_sequence.txt

MCP Python SDK使い方については、以下のファイルを参照
- reference/mcp_python_sdk.md

## セキュリティガイドライン

- 機密情報（API キー、パスワードなど）はハードコーディングしない
- ユーザー入力は必ず検証する
- 環境変数を適切に使用する
- `.env` ファイルなど機密ファイルは絶対に変更しな

## コーディングガイドライン

### 一般原則
- シンプルで読みやすいコード
- 適切な命名（変数、関数、クラスなど）
- 一つの関数は一つの責務を持つ
- エラーハンドリングを適切に実装
- コメントは必要な箇所にのみ付ける

### コーディング規約
- PEP8, ANSIスタイル  
- フォーマッター: `black`, インポート整頓: `isort`  

### テスト
- 主要機能のユニットテスト
- エッジケースの考慮
- テストが実行可能であることを確認

### リーダブルコード

- コードのより良い書き方は reference/readable_code.md を参照

## コミットメッセージのガイドライン

簡潔かつ明確なコミットメッセージを記述することで、変更履歴を追いやすくします。

- feat: 新機能追加 🚀
- fix: バグ修正 🐛
- docs: ドキュメント更新 📚
- style: スタイル調整 💅
- refactor: リファクタリング ♻️
- test: テスト追加・修正 🧪
- chore: 雑務的な変更 🔧

### コミットの注意事項

- 1つのコミットでは1つの論理的な変更のみを含める
- 複数の変更がある場合は複数のコミットに分割する
- コミットメッセージは日本語で記述可能

### コミットのやり方

`git add . && git commit -m "feat: ユーザー登録機能を追加"` のようにコミットメッセージを記述してコミットしてください。

コミットは自動的にコマンドを実行せず、必ず指示者の確認を経てから行ってください。

## ベストプラクティス

- 汎用的で再利用可能なコンポーネントを作成
- 基本的なパフォーマンス最適化を実装
- 基本的なアクセシビリティ対応を実装
- Core Web Vitalsを意識した実装
